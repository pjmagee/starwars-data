@page "/events"
@using System.Web
@inject HttpClient Http

<PageTitle>Star Wars Data</PageTitle>

 @if (_categories is not null)
{
    <MudSelect T="string" MultiSelection="true" SelectedValues="_selectedCategories" SelectedValuesChanged="SelectedValuesChanged">
        @foreach (var category in _categories)
        {
            <MudSelectItem T="string" Value="category">@category</MudSelectItem>
        }
    </MudSelect>    
}

@if(_pagedResult is not null)
{
    <MudPagination @ref="_pagination" Class="ma-4 sticky" ShowFirstButton="true" ShowLastButton="true" Count="_pages" SelectedChanged="Paginate" />

    <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelineAlign="TimelineAlign.Default" TimelinePosition="TimelinePosition.Alternate" Class="ma-4">
        
        @{
            var isStart = true;
        }
        
        @foreach (var item in _pagedResult.Items)
        {
            var color = GetColor(item);
            var contentAlign = isStart ? Align.Left : Align.Right;
            var yearAlign = isStart ? Align.Right : Align.Left;
            var title = $"{GetTitle(item)} - ({item.Template})";
           

            <MudTimelineItem Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Medium">
                @* <ItemDot> *@
                @*     <MudIcon Size="Size.Medium" Icon="@"/> *@
                @* </ItemDot> *@
                 <ItemOpposite>
                    <MudText Color="Color.Info" Typo="Typo.h5" Align="yearAlign">
                       @item.Year.ToString("#,###") @Enum.GetName(typeof(Demarcation), item.Demarcation)
                   </MudText>
                </ItemOpposite>
                <ItemContent>
                     <MudExpansionPanels>
                         <MudExpansionPanel Text="@title" MaxHeight="1000" Style="@($"color:{color}; text-align:{contentAlign};")">
                             <MudText Class="mud-text-secondary" Align="contentAlign">
                                 @foreach (var value  in item.Values)
                                 {
                                     @(value)
                                     <br/>
                                 }
                             </MudText>
                         </MudExpansionPanel>
                     </MudExpansionPanels>
                </ItemContent>
               
            </MudTimelineItem>

            isStart = !isStart;
        }
    </MudTimeline>
}

@code {

    private PagedResult<TimelineEvent>? _pagedResult;
    private string[]? _categories;
    private List<string>? _selectedCategories;

    private int _pages = 1;
    private int _pageSize = 15;
    private MudPagination _pagination;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        _categories = await Http.GetFromJsonAsync<string[]>("Timeline/categories");
        StateHasChanged();
    }

    private async Task Paginate(int page)
    {
        var query = HttpUtility.ParseQueryString(string.Empty);
        
        query.Add("Page", $"{page}");
        query.Add("PageSize", $"{_pageSize}");
       
        foreach (var c in _selectedCategories ?? Enumerable.Empty<string>())
        {
            query.Add("Categories", $"{c}");
        }
        
        _pagedResult = await Http.GetFromJsonAsync<PagedResult<TimelineEvent>>($"Timeline?{query}");
        _pages = _pagedResult.Total / _pagedResult.Size;
    }

    private string GetTitle(TimelineEvent timelineEvent)
    {
        return string.IsNullOrWhiteSpace(timelineEvent.EventType) ? timelineEvent.Title : $"{timelineEvent.EventType} - {timelineEvent.Title}";
    }

    private string GetColor(TimelineEvent timelineEvent)
    {
        return timelineEvent.Template switch 
        {
            "Event" => Colors.LightBlue.Lighten1,

            "Campaign" => Colors.Shades.Black,
            "Mission" => Colors.Grey.Darken4,
            
            "War" => Colors.Red.Darken4,
            "Battle" => Colors.Red.Darken3,
            "Duel" => Colors.Red.Darken2,
            "Fleet" => Colors.Red.Lighten1,
            
            "Disease" => Colors.Green.Darken4,
            
            "Location" => Colors.Blue.Lighten1,
            "City" => Colors.Blue.Default,
            "Law" => Colors.Blue.Darken1,
            "Treaty" => Colors.Blue.Darken2,
            "Election" => Colors.Blue.Darken3,
            
            "Character" => Colors.Green.Default,
            
            "Government" => Colors.Amber.Darken1,
            "Organization" => Colors.Amber.Darken2,
            "Company" => Colors.Amber.Darken3,
            
            "Lightsaber" => Colors.Purple.Darken1,
            "Droid" => Colors.BlueGrey.Darken2,
            "Artifact" => Colors.BlueGrey.Darken3,
            
            _ => Colors.Blue.Default
        };
    }

    private async Task SelectedValuesChanged(IEnumerable<string> selectedCategories)
    {
        _selectedCategories = new List<string>(selectedCategories);
        
        await Paginate(1);
        StateHasChanged();
    }
}